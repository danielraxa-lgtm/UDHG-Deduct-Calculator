<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pending Bonds | Unified Door and Hardware Group</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .header {
            background: #8B2332;
            color: white;
            padding: 20px 40px;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Login Gate */
        .login-gate {
            max-width: 400px;
            margin: 80px auto;
            background: white;
            border-radius: 8px;
            padding: 40px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.15);
            text-align: center;
        }

        .login-gate h2 {
            color: #8B2332;
            margin-bottom: 8px;
        }

        .login-gate p {
            color: #666;
            margin-bottom: 25px;
            font-size: 0.95rem;
        }

        .login-gate .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-gate input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .login-gate input[type="password"]:focus {
            outline: none;
            border-color: #8B2332;
        }

        .login-error {
            color: #c0392b;
            font-size: 0.9rem;
            margin-bottom: 15px;
            display: none;
        }

        /* Main Content (hidden until authenticated) */
        .main-content {
            display: none;
        }

        .main-content.show {
            display: block;
        }

        .nav-links {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-link {
            display: inline-block;
            padding: 10px 18px;
            background: white;
            color: #8B2332;
            border: 2px solid #8B2332;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .nav-link:hover {
            background: #8B2332;
            color: white;
        }

        .section-card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .section-title {
            color: #8B2332;
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            border-bottom: 2px solid #8B2332;
            padding-bottom: 8px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #8B2332;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            text-decoration: none;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #6d1a27;
        }

        .btn-sm {
            padding: 6px 14px;
            font-size: 0.85rem;
        }

        .btn-secondary {
            background: #666;
        }

        .btn-secondary:hover {
            background: #555;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .btn-danger {
            background: #c0392b;
        }

        .btn-danger:hover {
            background: #a93226;
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 120px;
            text-align: center;
        }

        .stat-box .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #8B2332;
        }

        .stat-box .stat-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-bar select,
        .filter-bar input {
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            font-family: inherit;
        }

        .filter-bar select:focus,
        .filter-bar input:focus {
            outline: none;
            border-color: #8B2332;
        }

        .filter-bar input {
            flex: 1;
            min-width: 200px;
        }

        /* Bond Table */
        .bond-table-wrapper {
            overflow-x: auto;
        }

        .bond-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .bond-table th {
            background: #8B2332;
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }

        .bond-table th:hover {
            background: #6d1a27;
        }

        .bond-table th .sort-arrow {
            margin-left: 4px;
            font-size: 0.7rem;
        }

        .bond-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }

        .bond-table tr:hover {
            background: #f9f9f9;
        }

        .bond-table .actions {
            white-space: nowrap;
        }

        .bond-table .actions button {
            margin-right: 4px;
            margin-bottom: 4px;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-submitted { background: #cce5ff; color: #004085; }
        .status-active { background: #d4edda; color: #155724; }
        .status-released { background: #e2e3e5; color: #383d41; }
        .status-denied { background: #f8d7da; color: #721c24; }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .empty-state p {
            margin-bottom: 15px;
        }

        /* Add Bond Form (Modal-style) */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 40px 20px;
        }

        .modal-overlay.show {
            display: block;
        }

        .modal {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            position: relative;
        }

        .modal h2 {
            color: #8B2332;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .modal .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
        }

        .modal .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #444;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #8B2332;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            .stats-bar {
                flex-direction: column;
            }
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #888;
            font-size: 0.85rem;
        }

        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #8B2332;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 6px 6px 0;
            font-size: 0.9rem;
        }

        .import-banner {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-left: 4px solid #28a745;
            border-radius: 0 6px 6px 0;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .import-banner.show {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .import-banner .import-text {
            color: #155724;
            font-weight: 500;
        }

        .import-banner .dismiss-btn {
            background: none;
            border: none;
            color: #155724;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 5px;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .sharepoint-link {
            display: inline-block;
            margin-left: 10px;
            padding: 6px 14px;
            background: #0078d4;
            color: white;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .sharepoint-link:hover {
            background: #005a9e;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>UNIFIED DOOR & HARDWARE — Pending Bonds</h1>
        <div class="subtitle">Bond tracking and management</div>
    </div>

    <div class="container">
        <!-- Login Gate -->
        <div class="login-gate" id="loginGate">
            <h2>Pending Bonds</h2>
            <p>This page is restricted. Enter the password to continue.</p>
            <div class="login-error" id="loginError">Incorrect password. Please try again.</div>
            <div class="form-group">
                <input type="password" id="passwordInput" placeholder="Enter password" onkeydown="if(event.key==='Enter') authenticate()">
            </div>
            <button class="btn" onclick="authenticate()">Unlock</button>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="ocip_ccip.html" class="nav-link">Insurance Hub</a>
                <a href="calculator.html" class="nav-link">Deduction Calculator</a>
                <a href="bond_request.html" class="nav-link">Bond Request</a>
            </div>

            <!-- Import Banner (shown when bond is imported via URL) -->
            <div class="import-banner" id="importBanner">
                <span class="import-text" id="importText">Bond imported successfully!</span>
                <button class="dismiss-btn" onclick="dismissImportBanner()">&times;</button>
            </div>

            <!-- Stats -->
            <div class="stats-bar" id="statsBar">
                <div class="stat-box">
                    <div class="stat-number" id="statTotal">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="statPending">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="statSubmitted">0</div>
                    <div class="stat-label">Submitted</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="statActive">0</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="statValue">$0</div>
                    <div class="stat-label">Total Value</div>
                </div>
            </div>

            <!-- Filter & Actions -->
            <div class="section-card">
                <div class="filter-bar">
                    <input type="text" id="searchInput" placeholder="Search by project, obligee, or requestor..." oninput="renderBonds()">
                    <select id="filterStatus" onchange="renderBonds()">
                        <option value="all">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="Submitted">Submitted</option>
                        <option value="Active">Active</option>
                        <option value="Released">Released</option>
                        <option value="Denied">Denied</option>
                    </select>
                    <select id="filterType" onchange="renderBonds()">
                        <option value="all">All Bond Types</option>
                        <option value="Bid Bond">Bid Bond</option>
                        <option value="Performance Bond">Performance Bond</option>
                        <option value="Payment Bond">Payment Bond</option>
                        <option value="Performance + Payment Bond">Performance + Payment</option>
                        <option value="Maintenance Bond">Maintenance Bond</option>
                        <option value="Supply Bond">Supply Bond</option>
                    </select>
                    <button class="btn btn-success btn-sm" onclick="showAddModal()">+ Add Bond</button>
                </div>

                <div class="info-box" style="margin-bottom: 20px;">
                    Bonds submitted via the Bond Request form appear here automatically when you click the "Add to Tracker" link in the email.
                    <a href="https://commercialhardware.sharepoint.com/sites/BondInsuranceTracking-ADP/Shared%20Documents/Forms/AllItems.aspx?e=5%3A0b01df5da6f24dfda73434a4ce3396f6&sharingv2=true&fromShare=true&at=9&CID=6341e7a8%2D13c8%2D42e4%2Db02f%2D9bf16968add5&FolderCTID=0x0120004EE1568D06C2114FAEEF7EC1C32B826E&id=%2Fsites%2FBondInsuranceTracking%2DADP%2FShared%20Documents%2FBond%20Tracking" target="_blank" class="sharepoint-link">Open SharePoint Folder</a>
                </div>

                <!-- Bond Table -->
                <div class="bond-table-wrapper">
                    <table class="bond-table" id="bondTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('bondNumber')">Bond # <span class="sort-arrow"></span></th>
                                <th onclick="sortTable('dateSubmitted')">Date <span class="sort-arrow"></span></th>
                                <th onclick="sortTable('bondType')">Bond Type <span class="sort-arrow"></span></th>
                                <th onclick="sortTable('dba')">Principal / DBA <span class="sort-arrow"></span></th>
                                <th onclick="sortTable('obligee')">Obligee <span class="sort-arrow"></span></th>
                                <th onclick="sortTable('projectName')">Description <span class="sort-arrow"></span></th>
                                <th onclick="sortTable('bondAmount')">Bond Amount <span class="sort-arrow"></span></th>
                                <th onclick="sortTable('bondPremium')">Premium <span class="sort-arrow"></span></th>
                                <th onclick="sortTable('suretyCompany')">Surety <span class="sort-arrow"></span></th>
                                <th onclick="sortTable('closingDate')">Closing Date <span class="sort-arrow"></span></th>
                                <th onclick="sortTable('status')">Status <span class="sort-arrow"></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bondTableBody">
                        </tbody>
                    </table>
                </div>

                <div class="empty-state" id="emptyState" style="display: none;">
                    <p>No bonds found.</p>
                    <button class="btn btn-success" onclick="showAddModal()">+ Add Your First Bond</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Bond Modal -->
    <div class="modal-overlay" id="bondModal">
        <div class="modal">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <h2 id="modalTitle">Add New Bond</h2>

            <div class="form-grid">
                <div class="form-group">
                    <label for="modalBondNumber">Bond Number</label>
                    <input type="text" id="modalBondNumber" placeholder="e.g., SU1234567">
                </div>
                <div class="form-group">
                    <label for="modalStatus">Status</label>
                    <select id="modalStatus">
                        <option value="Pending">Pending</option>
                        <option value="Submitted">Submitted to Surety</option>
                        <option value="Active">Active</option>
                        <option value="Released">Released</option>
                        <option value="Denied">Denied</option>
                    </select>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="modalBondType">Bond Type</label>
                    <select id="modalBondType">
                        <option value="Bid Bond">Bid Bond</option>
                        <option value="Performance Bond">Performance Bond</option>
                        <option value="Payment Bond">Payment Bond</option>
                        <option value="Performance + Payment Bond">Performance + Payment</option>
                        <option value="Maintenance Bond">Maintenance Bond</option>
                        <option value="Supply Bond">Supply Bond</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modalDba">Principal / DBA</label>
                    <select id="modalDba">
                        <option value="">Unified Door and Hardware Group, LLC</option>
                        <option value="A.G. Mauro">A.G. Mauro</option>
                        <option value="American Direct Procurement">American Direct Procurement</option>
                        <option value="Commercial Hardware of MD">Commercial Hardware of MD</option>
                        <option value="Construction Interior Products">Construction Interior Products</option>
                        <option value="Eaton Door and Frame">Eaton Door and Frame</option>
                        <option value="Joffe Millwork & Supply">Joffe Millwork & Supply</option>
                        <option value="Liberty Door Systems">Liberty Door Systems</option>
                        <option value="LIF Industries">LIF Industries</option>
                        <option value="New Door Installation">New Door Installation</option>
                        <option value="Next Door Distribution">Next Door Distribution</option>
                        <option value="Rayhaven Group">Rayhaven Group</option>
                        <option value="Specialty Services of New England">Specialty Services of New England</option>
                        <option value="Unified Specialty Services">Unified Specialty Services</option>
                        <option value="Weinstein & Holtzman of New York">Weinstein & Holtzman of New York</option>
                        <option value="FBM Logistics LLC">FBM Logistics LLC</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="modalObligee">Obligee</label>
                <input type="text" id="modalObligee" placeholder="e.g., ABC Construction">
            </div>

            <div class="form-group">
                <label for="modalProject">Description / Project Name</label>
                <input type="text" id="modalProject" placeholder="e.g., Downtown Office Tower - Doors, Frames & Hardware">
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="modalBondAmount">Bond Amount ($)</label>
                    <input type="text" id="modalBondAmount" placeholder="e.g., 500,000" oninput="formatNumberInput(this)">
                </div>
                <div class="form-group">
                    <label for="modalBondPremium">Bond Premium ($)</label>
                    <input type="text" id="modalBondPremium" placeholder="e.g., 12,500" oninput="formatNumberInput(this)">
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="modalSuretyCompany">Surety Company</label>
                    <select id="modalSuretyCompany">
                        <option value="">Select...</option>
                        <option value="Liberty Mutual">Liberty Mutual</option>
                        <option value="Travelers">Travelers</option>
                        <option value="CNA Surety">CNA Surety</option>
                        <option value="Hartford">Hartford</option>
                        <option value="Zurich">Zurich</option>
                        <option value="Tokio Marine HCC">Tokio Marine HCC</option>
                        <option value="Markel">Markel</option>
                        <option value="Great American">Great American</option>
                        <option value="Westfield">Westfield</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modalClosingDate">Closing Date</label>
                    <input type="date" id="modalClosingDate">
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="modalContractAmount">Contract Amount ($)</label>
                    <input type="text" id="modalContractAmount" placeholder="e.g., 1,200,000" oninput="formatNumberInput(this)">
                </div>
                <div class="form-group">
                    <label for="modalState">State</label>
                    <input type="text" id="modalState" placeholder="e.g., AZ, NY" maxlength="2" style="text-transform: uppercase;">
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="modalRequestor">Requestor Name</label>
                    <input type="text" id="modalRequestor" placeholder="e.g., Jane Smith">
                </div>
                <div class="form-group">
                    <label for="modalRequestorEmail">Requestor Email</label>
                    <input type="email" id="modalRequestorEmail" placeholder="e.g., jane@udhgroup.com">
                </div>
            </div>

            <div class="form-group">
                <label for="modalNotes">Notes</label>
                <textarea id="modalNotes" rows="3" placeholder="Any additional notes or context"></textarea>
            </div>

            <input type="hidden" id="modalBondId" value="">

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="saveBond()">Save Bond</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>UDHG Pending Bonds Tracker | Last Updated: February 2026</p>
        <p>Data stored locally in your browser. <button onclick="exportBonds()" style="background:none; border:none; color:#8B2332; cursor:pointer; text-decoration:underline; font-size:inherit;">Export as CSV</button></p>
    </div>

    <script>
        // Password hash (SHA-256) — actual password is not stored in source
        const ACCESS_HASH = '66807e7218a602714c51903981492683478cc9338758424b107a95ef21c2b0ee';
        const SESSION_KEY = 'udhg_bonds_auth';
        const STORAGE_KEY = 'udhg_pending_bonds';

        // Sorting state
        let currentSort = { field: 'dateSubmitted', direction: 'desc' };

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Check if already authenticated this session
        function checkAuth() {
            if (sessionStorage.getItem(SESSION_KEY) === 'true') {
                showMainContent();
            }
        }

        async function authenticate() {
            const input = document.getElementById('passwordInput').value;
            const inputHash = await hashPassword(input);
            if (inputHash === ACCESS_HASH) {
                sessionStorage.setItem(SESSION_KEY, 'true');
                document.getElementById('loginError').style.display = 'none';
                showMainContent();
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }

        function showMainContent() {
            document.getElementById('loginGate').style.display = 'none';
            document.getElementById('mainContent').classList.add('show');
            checkUrlImport();
            renderBonds();
        }

        // ========== URL IMPORT ==========
        // When Auri clicks the "Add to Tracker" link from the email,
        // the bond data is encoded in the URL and auto-imported here.
        function checkUrlImport() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('action') !== 'import') return;

            const bondData = {
                id: Date.now().toString(),
                bondNumber: '',
                bondType: params.get('bondType') || '',
                bondAmount: parseFloat(params.get('bondAmount')) || 0,
                bondPremium: 0,
                principal: params.get('principal') || 'Unified Door and Hardware Group, LLC',
                dba: params.get('dba') || '',
                obligee: params.get('obligee') || '',
                obligeeAddress: params.get('obligeeAddress') || '',
                mailToObligee: params.get('mailToObligee') || 'no',
                projectName: params.get('projectName') || '',
                contractAmount: parseFloat(params.get('contractAmount')) || 0,
                projectAddress: params.get('projectAddress') || '',
                projectState: params.get('projectState') || '',
                scopeDescription: params.get('scopeDescription') || '',
                requestorName: params.get('requestorName') || '',
                requestorEmail: params.get('requestorEmail') || '',
                urgency: params.get('urgency') || 'normal',
                bidDate: params.get('bidDate') || '',
                maintenancePeriod: params.get('maintenancePeriod') || '',
                bondFormRequired: params.get('bondFormRequired') || '',
                suretyCompany: '',
                closingDate: '',
                dateSubmitted: new Date().toISOString(),
                status: 'Pending',
                notes: ''
            };

            // Check for duplicate (same project + obligee + bond amount within last 5 minutes)
            const bonds = getBonds();
            const isDuplicate = bonds.some(b =>
                b.projectName === bondData.projectName &&
                b.obligee === bondData.obligee &&
                b.bondAmount === bondData.bondAmount &&
                (Date.now() - new Date(b.dateSubmitted).getTime()) < 300000
            );

            if (!isDuplicate) {
                bonds.push(bondData);
                setBonds(bonds);

                // Show success banner
                const banner = document.getElementById('importBanner');
                document.getElementById('importText').textContent =
                    `Bond imported: ${bondData.bondType} - ${bondData.projectName} ($${bondData.bondAmount.toLocaleString()}) from ${bondData.requestorName}`;
                banner.classList.add('show');
            }

            // Clean the URL without reloading (remove the query params)
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        function dismissImportBanner() {
            document.getElementById('importBanner').classList.remove('show');
        }

        // Format number input with commas
        function formatNumberInput(input) {
            const cursorPos = input.selectionStart;
            const oldLength = input.value.length;
            let value = input.value.replace(/[^0-9.]/g, '');
            const parts = value.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            input.value = parts.join('.');
            const newLength = input.value.length;
            const diff = newLength - oldLength;
            input.setSelectionRange(cursorPos + diff, cursorPos + diff);
        }

        function parseNumber(value) {
            if (!value) return 0;
            return parseFloat(String(value).replace(/,/g, '')) || 0;
        }

        function formatCurrency(num) {
            if (!num) return '-';
            return '$' + Number(num).toLocaleString();
        }

        // Get all bonds from localStorage
        function getBonds() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        }

        // Save bonds array to localStorage
        function setBonds(bonds) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(bonds));
        }

        // Update stats display
        function updateStats(bonds) {
            const total = bonds.length;
            const pending = bonds.filter(b => b.status === 'Pending').length;
            const submitted = bonds.filter(b => b.status === 'Submitted').length;
            const active = bonds.filter(b => b.status === 'Active').length;
            const totalValue = bonds.reduce((sum, b) => sum + (parseFloat(b.bondAmount) || 0), 0);

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPending').textContent = pending;
            document.getElementById('statSubmitted').textContent = submitted;
            document.getElementById('statActive').textContent = active;
            document.getElementById('statValue').textContent = totalValue > 0
                ? '$' + totalValue.toLocaleString(undefined, { maximumFractionDigits: 0 })
                : '$0';
        }

        // Sorting
        function sortTable(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            renderBonds();
        }

        function sortBonds(bonds) {
            const { field, direction } = currentSort;
            return bonds.sort((a, b) => {
                let valA = a[field] || '';
                let valB = b[field] || '';

                // Numeric fields
                if (['bondAmount', 'bondPremium', 'contractAmount'].includes(field)) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                }
                // Date fields
                else if (['dateSubmitted', 'closingDate'].includes(field)) {
                    valA = valA ? new Date(valA).getTime() : 0;
                    valB = valB ? new Date(valB).getTime() : 0;
                }
                // String fields
                else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // Render the bonds table
        function renderBonds() {
            const bonds = getBonds();
            const search = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const typeFilter = document.getElementById('filterType').value;

            // Filter
            const filtered = bonds.filter(bond => {
                const matchesSearch = !search ||
                    (bond.projectName || '').toLowerCase().includes(search) ||
                    (bond.obligee || '').toLowerCase().includes(search) ||
                    (bond.requestorName || '').toLowerCase().includes(search) ||
                    (bond.bondNumber || '').toLowerCase().includes(search) ||
                    (bond.dba || '').toLowerCase().includes(search) ||
                    (bond.suretyCompany || '').toLowerCase().includes(search);
                const matchesStatus = statusFilter === 'all' || bond.status === statusFilter;
                const matchesType = typeFilter === 'all' || bond.bondType === typeFilter;
                return matchesSearch && matchesStatus && matchesType;
            });

            // Sort
            sortBonds(filtered);

            updateStats(bonds);

            const tbody = document.getElementById('bondTableBody');
            const emptyState = document.getElementById('emptyState');
            const table = document.getElementById('bondTable');

            if (filtered.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
            } else {
                table.style.display = 'table';
                emptyState.style.display = 'none';

                tbody.innerHTML = filtered.map(bond => {
                    const date = bond.dateSubmitted
                        ? new Date(bond.dateSubmitted).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                        : '-';
                    const closingDate = bond.closingDate
                        ? new Date(bond.closingDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                        : '-';
                    const amount = bond.bondAmount ? formatCurrency(bond.bondAmount) : '-';
                    const premium = bond.bondPremium ? formatCurrency(bond.bondPremium) : '-';
                    const statusClass = 'status-' + (bond.status || 'pending').toLowerCase();
                    const principalDisplay = bond.dba || 'UDHG';

                    return `<tr>
                        <td>${bond.bondNumber || '<span style="color:#bbb">—</span>'}</td>
                        <td style="white-space:nowrap">${date}</td>
                        <td>${bond.bondType || '-'}</td>
                        <td>${principalDisplay}</td>
                        <td>${bond.obligee || '-'}</td>
                        <td>${bond.projectName || '-'}</td>
                        <td style="white-space:nowrap">${amount}</td>
                        <td style="white-space:nowrap">${premium}</td>
                        <td>${bond.suretyCompany || '-'}</td>
                        <td style="white-space:nowrap">${closingDate}</td>
                        <td><span class="status-badge ${statusClass}">${bond.status || 'Pending'}</span></td>
                        <td class="actions">
                            <button class="btn btn-sm btn-secondary" onclick="editBond('${bond.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBond('${bond.id}')">Del</button>
                        </td>
                    </tr>`;
                }).join('');
            }
        }

        // Show add modal
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'Add New Bond';
            document.getElementById('modalBondId').value = '';
            document.getElementById('modalBondNumber').value = '';
            document.getElementById('modalBondType').value = 'Bid Bond';
            document.getElementById('modalStatus').value = 'Pending';
            document.getElementById('modalDba').value = '';
            document.getElementById('modalProject').value = '';
            document.getElementById('modalObligee').value = '';
            document.getElementById('modalBondAmount').value = '';
            document.getElementById('modalBondPremium').value = '';
            document.getElementById('modalContractAmount').value = '';
            document.getElementById('modalSuretyCompany').value = '';
            document.getElementById('modalClosingDate').value = '';
            document.getElementById('modalState').value = '';
            document.getElementById('modalRequestor').value = '';
            document.getElementById('modalRequestorEmail').value = '';
            document.getElementById('modalNotes').value = '';
            document.getElementById('bondModal').classList.add('show');
        }

        // Edit existing bond
        function editBond(id) {
            const bonds = getBonds();
            const bond = bonds.find(b => b.id === id);
            if (!bond) return;

            document.getElementById('modalTitle').textContent = 'Edit Bond';
            document.getElementById('modalBondId').value = bond.id;
            document.getElementById('modalBondNumber').value = bond.bondNumber || '';
            document.getElementById('modalBondType').value = bond.bondType || 'Bid Bond';
            document.getElementById('modalStatus').value = bond.status || 'Pending';
            document.getElementById('modalDba').value = bond.dba || '';
            document.getElementById('modalProject').value = bond.projectName || '';
            document.getElementById('modalObligee').value = bond.obligee || '';
            document.getElementById('modalBondAmount').value = bond.bondAmount ? Number(bond.bondAmount).toLocaleString() : '';
            document.getElementById('modalBondPremium').value = bond.bondPremium ? Number(bond.bondPremium).toLocaleString() : '';
            document.getElementById('modalContractAmount').value = bond.contractAmount ? Number(bond.contractAmount).toLocaleString() : '';
            document.getElementById('modalSuretyCompany').value = bond.suretyCompany || '';
            document.getElementById('modalClosingDate').value = bond.closingDate || '';
            document.getElementById('modalState').value = bond.projectState || '';
            document.getElementById('modalRequestor').value = bond.requestorName || '';
            document.getElementById('modalRequestorEmail').value = bond.requestorEmail || '';
            document.getElementById('modalNotes').value = bond.notes || '';
            document.getElementById('bondModal').classList.add('show');
        }

        // Save bond (add or update)
        function saveBond() {
            const id = document.getElementById('modalBondId').value;
            const bonds = getBonds();

            const bondData = {
                bondNumber: document.getElementById('modalBondNumber').value.trim(),
                bondType: document.getElementById('modalBondType').value,
                status: document.getElementById('modalStatus').value,
                dba: document.getElementById('modalDba').value,
                projectName: document.getElementById('modalProject').value.trim(),
                obligee: document.getElementById('modalObligee').value.trim(),
                bondAmount: parseNumber(document.getElementById('modalBondAmount').value),
                bondPremium: parseNumber(document.getElementById('modalBondPremium').value),
                contractAmount: parseNumber(document.getElementById('modalContractAmount').value),
                suretyCompany: document.getElementById('modalSuretyCompany').value,
                closingDate: document.getElementById('modalClosingDate').value,
                projectState: document.getElementById('modalState').value.toUpperCase(),
                requestorName: document.getElementById('modalRequestor').value.trim(),
                requestorEmail: document.getElementById('modalRequestorEmail').value.trim(),
                notes: document.getElementById('modalNotes').value.trim()
            };

            if (id) {
                // Update existing — preserve fields not in the modal
                const index = bonds.findIndex(b => b.id === id);
                if (index !== -1) {
                    const existing = bonds[index];
                    bondData.id = id;
                    bondData.principal = existing.principal || 'Unified Door and Hardware Group, LLC';
                    bondData.dateSubmitted = existing.dateSubmitted;
                    bondData.dateModified = new Date().toISOString();
                    // Preserve fields from the original import
                    bondData.obligeeAddress = existing.obligeeAddress || '';
                    bondData.mailToObligee = existing.mailToObligee || '';
                    bondData.projectAddress = existing.projectAddress || '';
                    bondData.scopeDescription = existing.scopeDescription || '';
                    bondData.urgency = existing.urgency || '';
                    bondData.bidDate = existing.bidDate || '';
                    bondData.maintenancePeriod = existing.maintenancePeriod || '';
                    bondData.bondFormRequired = existing.bondFormRequired || '';
                    bonds[index] = bondData;
                }
            } else {
                // Add new
                bondData.id = Date.now().toString();
                bondData.principal = 'Unified Door and Hardware Group, LLC';
                bondData.dateSubmitted = new Date().toISOString();
                bonds.push(bondData);
            }

            setBonds(bonds);
            closeModal();
            renderBonds();
        }

        // Delete bond
        function deleteBond(id) {
            if (!confirm('Are you sure you want to delete this bond?')) return;
            const bonds = getBonds().filter(b => b.id !== id);
            setBonds(bonds);
            renderBonds();
        }

        // Close modal
        function closeModal() {
            document.getElementById('bondModal').classList.remove('show');
        }

        // Close modal when clicking outside
        document.getElementById('bondModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Export as CSV (matches FBM spreadsheet columns)
        function exportBonds() {
            const bonds = getBonds();
            if (bonds.length === 0) {
                alert('No bonds to export.');
                return;
            }

            const headers = ['Bond Number', 'Date Submitted', 'Bond Type', 'Principal / DBA', 'Obligee', 'Description / Project', 'Bond Amount', 'Bond Premium', 'Contract Amount', 'Surety Company', 'Closing Date', 'State', 'Status', 'Requestor', 'Requestor Email', 'Notes'];
            const rows = bonds.map(b => [
                b.bondNumber || '',
                b.dateSubmitted ? new Date(b.dateSubmitted).toLocaleDateString() : '',
                b.bondType || '',
                b.dba || 'UDHG',
                b.obligee || '',
                b.projectName || '',
                b.bondAmount || '',
                b.bondPremium || '',
                b.contractAmount || '',
                b.suretyCompany || '',
                b.closingDate || '',
                b.projectState || '',
                b.status || '',
                b.requestorName || '',
                b.requestorEmail || '',
                (b.notes || '').replace(/"/g, '""')
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(val => `"${val}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'udhg_bond_tracker_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Escape key closes modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeModal();
        });

        // Check auth on load
        checkAuth();
    </script>
</body>
</html>
