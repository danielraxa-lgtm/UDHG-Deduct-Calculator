<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insurance Cost Worksheet Calculator</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px 40px;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .header .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .confidential-banner {
            background: #c0392b;
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .confidential-banner strong {
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #2c3e50;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 0 6px 6px 0;
        }
        
        .calc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 768px) {
            .calc-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .calc-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .calc-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.1rem;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #444;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2c3e50;
        }
        
        .form-group small {
            display: block;
            margin-top: 4px;
            color: #888;
            font-size: 0.85rem;
        }
        
        .results {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
        }
        
        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .result-row:last-child {
            border-bottom: none;
        }
        
        .result-row.total {
            font-weight: 700;
            font-size: 1.2rem;
            color: #2c3e50;
            border-top: 2px solid #2c3e50;
            margin-top: 10px;
            padding-top: 15px;
        }
        
        .result-label {
            color: #666;
        }
        
        .result-value {
            font-weight: 600;
        }
        
        .subcontractor-section {
            display: none;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .subcontractor-section.show {
            display: block;
        }
        
        .subcontractor-section h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1rem;
        }
        
        .alert {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }
        
        .alert.show {
            display: block;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            text-decoration: none;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #1a252f;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #d68910;
        }
        
        .btn-back {
            background: #7f8c8d;
            margin-bottom: 20px;
        }
        
        .btn-back:hover {
            background: #636e72;
        }
        
        .btn-email {
            background: #27ae60;
            margin-top: 15px;
            width: 100%;
        }
        
        .btn-email:hover {
            background: #219a52;
        }
        
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: #888;
            font-size: 0.85rem;
            border-top: 1px solid #ddd;
            margin-top: 40px;
        }
        
        .footer .developer {
            margin-bottom: 10px;
            color: #666;
        }
        
        .contact-box {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
        
        .contact-box p {
            margin: 5px 0;
            color: #555;
        }
        
        .warning-text {
            color: #856404;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .result-row.subtotal {
            border-top: 1px solid #ccc;
            margin-top: 5px;
            padding-top: 12px;
        }

        .result-row.op-row {
            color: #27ae60;
        }

        .result-row.op-row .result-value {
            color: #27ae60;
        }

        .op-checkbox {
            margin-top: 15px;
            padding: 12px;
            background: #f0f9f4;
            border-radius: 6px;
            border: 1px solid #27ae60;
        }

        .op-checkbox label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
            color: #27ae60;
        }

        .op-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .rate-info {
            background: #e8f4f8;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
            font-size: 0.85rem;
        }

        .rate-info h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .rate-info p {
            margin: 4px 0;
            color: #555;
        }

        .rate-info .effective-rate {
            font-weight: 600;
            color: #27ae60;
        }

        .labor-note {
            background: #fff8e1;
            border: 1px solid #ffca28;
            border-radius: 6px;
            padding: 12px;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #6d4c00;
        }

        .labor-note a {
            color: #6d4c00;
            font-weight: 600;
        }

        .other-state-group {
            display: none;
            margin-top: 10px;
        }

        .other-state-group.show {
            display: block;
        }

        .email-section {
            margin-top: 20px;
            padding: 20px;
            background: #f0f9f4;
            border-radius: 8px;
            border: 1px solid #27ae60;
        }

        .email-section h3 {
            color: #27ae60;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .email-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .section-divider {
            border: none;
            border-top: 1px solid #eee;
            margin: 20px 0;
        }

        .section-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #999;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="confidential-banner">
        <strong>‚ö†Ô∏è Confidential</strong> ‚Äî Internal use only. Do not distribute this calculator to external parties.
    </div>
    
    <div class="header">
        <h1>Insurance Cost Worksheet Calculator</h1>
        <div class="subtitle">OCIP/CCIP Deduction Estimator for Bid Preparation | Updated Feb 2026</div>
    </div>
    
    <div class="container">
        <a href="index.html" class="btn btn-back">‚Üê Back to Insurance Hub</a>
        
        <div class="info-box">
            <strong>Purpose:</strong> This calculator is intended for estimating insurance deductions during the bid process, typically prior to any contracts being signed. Use it to calculate OCIP/CCIP credits for your bid pricing. <strong>Note:</strong> Large deductible factors are applied automatically for applicable states.
        </div>
        
        <div class="calc-grid">
            <div class="calc-section">
                <h2>Project Information</h2>

                <div class="section-label">GC / Customer</div>
                
                <div class="form-group">
                    <label for="gcName">GC / Customer Name</label>
                    <input type="text" id="gcName" placeholder="e.g., Turner Construction">
                    <small>Parent contractor or customer we're working under</small>
                </div>
                
                <div class="form-group">
                    <label for="gcContact">GC / Customer Contact (optional)</label>
                    <input type="text" id="gcContact" placeholder="e.g., Mike Johnson - mike@turner.com">
                </div>

                <hr class="section-divider">
                <div class="section-label">Project Details</div>
                
                <div class="form-group">
                    <label for="projectName">Project Name</label>
                    <input type="text" id="projectName" placeholder="e.g., Downtown Office Tower Phase 2">
                </div>

                <div class="form-group">
                    <label for="projectAddress">Project Address (optional)</label>
                    <input type="text" id="projectAddress" placeholder="e.g., 123 Main St, Hartford, CT">
                </div>

                <div class="form-group">
                    <label for="startDate">Estimated Start Date</label>
                    <input type="date" id="startDate">
                </div>
                
                <div class="form-group">
                    <label for="state">Project State</label>
                    <select id="state" onchange="handleStateChange()">
                        <option value="">Select State...</option>
                        <option value="AL">Alabama (AL)</option>
                        <option value="AR">Arkansas (AR)</option>
                        <option value="AZ">Arizona (AZ)</option>
                        <option value="CA">California (CA)</option>
                        <option value="CO">Colorado (CO)</option>
                        <option value="CT">Connecticut (CT)</option>
                        <option value="FL">Florida (FL)</option>
                        <option value="GA">Georgia (GA)</option>
                        <option value="HI">Hawaii (HI)</option>
                        <option value="IA">Iowa (IA)</option>
                        <option value="ID">Idaho (ID)</option>
                        <option value="IL">Illinois (IL)</option>
                        <option value="IN">Indiana (IN)</option>
                        <option value="KS">Kansas (KS)</option>
                        <option value="KY">Kentucky (KY)</option>
                        <option value="LA">Louisiana (LA)</option>
                        <option value="MA">Massachusetts (MA)</option>
                        <option value="MD">Maryland (MD)</option>
                        <option value="ME">Maine (ME)</option>
                        <option value="MI">Michigan (MI)</option>
                        <option value="MN">Minnesota (MN)</option>
                        <option value="MO">Missouri (MO)</option>
                        <option value="MS">Mississippi (MS)</option>
                        <option value="MT">Montana (MT)</option>
                        <option value="NC">North Carolina (NC)</option>
                        <option value="NE">Nebraska (NE)</option>
                        <option value="NH">New Hampshire (NH)</option>
                        <option value="NJ">New Jersey (NJ)</option>
                        <option value="NM">New Mexico (NM)</option>
                        <option value="NV">Nevada (NV)</option>
                        <option value="NY">New York (NY)</option>
                        <option value="OK">Oklahoma (OK)</option>
                        <option value="OR">Oregon (OR)</option>
                        <option value="PA">Pennsylvania (PA)</option>
                        <option value="RI">Rhode Island (RI)</option>
                        <option value="SC">South Carolina (SC)</option>
                        <option value="SD">South Dakota (SD)</option>
                        <option value="TN">Tennessee (TN)</option>
                        <option value="TX">Texas (TX)</option>
                        <option value="UT">Utah (UT)</option>
                        <option value="VA">Virginia (VA)</option>
                        <option value="WV">West Virginia (WV)</option>
                        <option value="other">Other State</option>
                    </select>
                    <div class="other-state-group" id="otherStateGroup">
                        <label for="otherStateInput">Enter State</label>
                        <input type="text" id="otherStateInput" placeholder="e.g., CA, WA, NV" oninput="updateClassCodeOptions(); calculate()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="contractValue">Contract or Change Order Value ($)</label>
                    <input type="text" id="contractValue" placeholder="e.g., 500,000" oninput="formatNumberInput(this); calculate()">
                    <small>Total sell price for the scope</small>
                </div>
                
                <div class="form-group">
                    <label for="laborScope">Labor Scope</label>
                    <select id="laborScope" onchange="toggleLaborFields(); calculate()">
                        <option value="none">None (Delivery/Supply Only)</option>
                        <option value="subcontracted">Subcontracted</option>
                        <option value="self">Self-Performed Crews</option>
                    </select>
                    <div class="labor-note">
                        <strong>Please note:</strong> Only self-install labor is counted in the WC calculation. If you're told otherwise, please reach out to <a href="mailto:wrap.enrollment@myfbm.com">wrap.enrollment@myfbm.com</a>.
                    </div>
                </div>

                <div class="form-group" id="classCodeGroup" style="display: none;">
                    <label for="classCode">WC Class Code</label>
                    <select id="classCode" onchange="calculate()">
                    </select>
                    <small id="classCodeHelp">Select the appropriate class code.</small>
                </div>
                
                <div class="form-group" id="payrollGroup" style="display: none;">
                    <label for="payroll">Estimated Self-Performed Payroll ($)</label>
                    <input type="text" id="payroll" placeholder="e.g., 100,000" oninput="formatNumberInput(this); calculate()">
                    <small>Use labor COST (payroll), not labor sell!</small>
                </div>
                
                <!-- Rate Info Box -->
                <div class="rate-info" id="rateInfoBox" style="display: none;">
                    <h4>üìä Rate Breakdown for <span id="rateState"></span></h4>
                    <p>Base WC Rate (<span id="displayClassCode">5102</span>): <span id="displayBaseRate"></span> per $100</p>
                    <p>EMR: <span id="displayEMR"></span></p>
                    <p>Large Deductible Factor: <span id="displayLDF"></span></p>
                    <p class="effective-rate">Effective WC Rate: <span id="displayEffectiveRate"></span> per $100</p>
                </div>
                
                <!-- Subcontractor Section -->
                <div class="subcontractor-section" id="subcontractorSection">
                    <h3>üìã Subcontractor Information Required</h3>
                    <p class="warning-text">When labor is subcontracted, we need the following information to coordinate wrap enrollment:</p>
                    
                    <div class="form-group">
                        <label for="subAmount">Subcontracted Labor Amount ($)</label>
                        <input type="text" id="subAmount" placeholder="e.g., 75,000" oninput="formatNumberInput(this)">
                    </div>
                    
                    <div class="form-group">
                        <label for="subName">Subcontractor Company Name</label>
                        <input type="text" id="subName" placeholder="e.g., ABC Installation Services">
                    </div>
                    
                    <div class="form-group">
                        <label for="subContactName">Subcontractor Contact Name</label>
                        <input type="text" id="subContactName" placeholder="e.g., John Smith">
                    </div>
                    
                    <div class="form-group">
                        <label for="subContactEmail">Subcontractor Contact Email</label>
                        <input type="email" id="subContactEmail" placeholder="e.g., jsmith@abcinstall.com">
                    </div>
                </div>
            </div>
            
            <div class="calc-section">
                <h2>Insurance Deduction Results</h2>
                
                <div class="results">
                    <div class="result-row">
                        <span class="result-label">Workers' Comp (WC)</span>
                        <span class="result-value" id="wcResult">$0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">General Liability (GL)</span>
                        <span class="result-value" id="glResult">$0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Umbrella/Excess</span>
                        <span class="result-value" id="umbrellaResult">$0</span>
                    </div>
                    <div class="result-row subtotal">
                        <span class="result-label">Subtotal</span>
                        <span class="result-value" id="subtotalResult">$0</span>
                    </div>
                    <div class="result-row op-row" id="opRow" style="display: none;">
                        <span class="result-label">Overhead & Profit (15%)</span>
                        <span class="result-value" id="opResult">$0</span>
                    </div>
                    <div class="result-row total">
                        <span class="result-label">Total OCIP/CCIP Deduction</span>
                        <span class="result-value" id="totalResult">$0</span>
                    </div>
                </div>

                <div class="op-checkbox">
                    <label>
                        <input type="checkbox" id="includeOP" onchange="calculate()">
                        Include 15% Overhead & Profit
                    </label>
                </div>
                
                <div class="alert" id="subAlert">
                    <strong>Note:</strong> Labor is subcontracted. WC exposure belongs to the subcontractor. Please complete the subcontractor information and notify the Wrap Enrollment team.
                </div>

                <!-- Email Wrap Enrollment Section -->
                <div class="email-section">
                    <h3>üìß Send to FBM Wrap Enrollment</h3>
                    <p style="font-size: 0.9rem; color: #555; margin-bottom: 15px;">Sends all project details and deduction results to the Wrap Enrollment team so enrollment can start right away.</p>
                    <button class="btn btn-email" onclick="emailWrapEnrollment()">Email Wrap Enrollment Team</button>
                </div>
                
                <div class="contact-box">
                    <p><strong>Questions?</strong></p>
                    <p>Contact the Wrap Enrollment Team</p>
                    <p><a href="mailto:wrap.enrollment@myfbm.com">wrap.enrollment@myfbm.com</a></p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <div class="developer">Developed by Daniel Raxa</div>
        <p>For internal bid preparation use only. Contact <a href="mailto:wrap.enrollment@myfbm.com">wrap.enrollment@myfbm.com</a> for enrollment questions.</p>
        <p style="margin-top: 10px; font-size: 0.8rem;">Last Updated: February 2026 | Policy Year 2025-26</p>
    </div>
    
    <script>
        // =========================================
        // WC INSTALLATION RATES BY STATE AND CLASS CODE
        // Source: 25-26 WC Policy Endorsements
        // =========================================
        const wcInstallRates = {
            'AL': { '5102': 3.650 },
            'AR': { '5102': 1.890 },
            'AZ': { '5102': 3.270 },
            'CA': { '5102': 9.970 },
            'CO': { '5102': 4.020 },
            'CT': { '5102': 4.510 },
            'FL': { '5102': 5.33 },
            'GA': { '5102': 4.030 },
            'HI': { '5102': 7.540 },
            'IA': { '5102': 3.050 },
            'ID': { '5102': 2.890 },
            'IL': { '5102': 3.900 },
            'IN': { '5102': 1.990 },
            'KS': { '5102': 2.940 },
            'KY': { '5102': 2.100 },
            'LA': { '5102': 3.820 },
            'MA': { '5102': 4.56 },
            'MD': { '5102': 2.710 },
            'ME': { '5102': 2.78 },
            'MI': { '5102': 2.130, '5146': 2.140 },
            'MN': { '5102': 2.600 },
            'MO': { '5102': 5.320 },
            'MS': { '5102': 2.900 },
            'MT': { '5102': 4.010 },
            'NC': { '5102': 3.090 },
            'NE': { '5102': 2.710 },
            'NH': { '5102': 4.420 },
            'NJ': { '5103': 6.28 },
            'NM': { '5102': 3.060 },
            'NV': { '5102': 5.110 },
            'NY': { '5102': 5.140 },
            'OK': { '5102': 3.670 },
            'OR': { '5102': 2.620 },
            'PA': { '658': 6.43 },
            'RI': { '5102': 4.480 },
            'SC': { '5102': 3.860 },
            'SD': { '5102': 3.530 },
            'TN': { '5102': 2.580, '5146': 1.910 },
            'TX': { '5102': 2.15 },
            'UT': { '5102': 1.860 },
            'VA': { '5102': 2.590 },
            'WV': { '5102': 1.320 }
        };

        // Class code descriptions
        const classCodeLabels = {
            '5102': 'Installation',
            '5103': 'Installation',
            '5146': 'Furniture Install',
            '658': 'Metal Erection Install',
            '8235': 'Supply Only'
        };

        // WC BASE RATES FOR SUPPLY-ONLY PAYROLL CLASS CODES
        // Source: 25-26 WC Policy Endorsements
        // =========================================
        const wcSupplyOnlyRates = {
            'CT': 3.48,   // Connecticut class code 8235 (supply only)
            'MA': 2.76,   // Massachusetts class code 8235 (supply only)
            'ME': 3.04,   // Maine class code 8235 (supply only)
            'RI': 3.82    // Rhode Island class code 8235 (supply only)
        };

        // =========================================
        // LARGE DEDUCTIBLE FACTORS BY STATE
        // Source: 25-26 WC Policy Rating Pages
        // $500K Deductible Program
        // =========================================
        const ldFactors = {
            'AL': 0.0706,
            'AR': 0.2214,
            'AZ': 0.2737,
            'CA': 0.0832,
            'CO': 0.0549,
            'CT': 0.0832,
            'FL': 0.2124,
            'GA': 0.054,
            'HI': 0.202,
            'IA': 0.2561,
            'ID': 0.0549,
            'IL': 0.0521,
            'IN': 0.0548,
            'KS': 0.0545,
            'KY': 0.0832,
            'LA': 0.0506,
            'MA': 0,      // No LD factor - different program structure
            'MD': 0.0548,
            'ME': 0,      // No LD factor on file
            'MI': 0.0833,
            'MN': 0.2094,
            'MO': 0.0832,
            'MS': 0.0835,
            'MT': 0.0832,
            'NC': 0.2541,
            'NE': 0.1386,
            'NH': 0.0831,
            'NJ': 0.0829,
            'NM': 0.0832,
            'NV': 0.0548,
            'NY': 0.0832,
            'OK': 0.0832,
            'OR': 0.1658,
            'PA': 0.1931,
            'RI': 0.0548,
            'SC': 0.0832,
            'SD': 0.0832,
            'TN': 0.0832,
            'TX': 0.08,
            'UT': 0.0548,
            'VA': 0.0832,
            'WV': 0.052
        };

        // =========================================
        // EMR (EXPERIENCE MODIFICATION RATE) BY STATE
        // Source: 25-26 WC Policy Rating Pages
        // =========================================
        const emrFactors = {
            'AL': 0.95,
            'AR': 0.95,
            'AZ': 0.95,
            'CA': 0.95,
            'CO': 0.95,
            'CT': 0.95,
            'FL': 0.95,
            'GA': 0.95,
            'HI': 0.95,
            'IA': 0.95,
            'ID': 0.95,
            'IL': 0.95,
            'IN': 0.95,
            'KS': 0.95,
            'KY': 0.95,
            'LA': 0.95,
            'MA': 1.01,
            'MD': 0.95,
            'ME': 0.95,
            'MI': 0.65,
            'MN': 0.95,
            'MO': 0.95,
            'MS': 0.95,
            'MT': 0.95,
            'NC': 0.95,
            'NE': 0.95,
            'NH': 0.95,
            'NJ': 1.115,
            'NM': 0.95,
            'NV': 0.95,
            'NY': 1.87,
            'OK': 0.95,
            'OR': 0.95,
            'PA': 1.143,
            'RI': 0.95,
            'SC': 0.95,
            'SD': 0.95,
            'TN': 0.95,
            'TX': 0.95,
            'UT': 0.95,
            'VA': 0.95,
            'WV': 0.95
        };

        // State full names for emails
        const stateNames = {
            'AL': 'Alabama', 'AR': 'Arkansas', 'AZ': 'Arizona',
            'CA': 'California', 'CO': 'Colorado', 'CT': 'Connecticut',
            'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii',
            'IA': 'Iowa', 'ID': 'Idaho', 'IL': 'Illinois',
            'IN': 'Indiana', 'KS': 'Kansas', 'KY': 'Kentucky',
            'LA': 'Louisiana', 'MA': 'Massachusetts', 'MD': 'Maryland',
            'ME': 'Maine', 'MI': 'Michigan', 'MN': 'Minnesota',
            'MO': 'Missouri', 'MS': 'Mississippi', 'MT': 'Montana',
            'NC': 'North Carolina', 'NE': 'Nebraska', 'NH': 'New Hampshire',
            'NJ': 'New Jersey', 'NM': 'New Mexico', 'NV': 'Nevada',
            'NY': 'New York', 'OK': 'Oklahoma', 'OR': 'Oregon',
            'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
            'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas',
            'UT': 'Utah', 'VA': 'Virginia', 'WV': 'West Virginia'
        };

        // GL and Umbrella rates (per $1,000 of contract value)
        const glRate = 0.1506;
        const umbrellaRate = 0.36691;

        // Format number input with commas as user types
        function formatNumberInput(input) {
            const cursorPos = input.selectionStart;
            const oldLength = input.value.length;

            let value = input.value.replace(/[^0-9.]/g, '');

            const parts = value.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');

            input.value = parts.join('.');

            const newLength = input.value.length;
            const diff = newLength - oldLength;
            input.setSelectionRange(cursorPos + diff, cursorPos + diff);
        }

        // Parse comma-formatted number back to float
        function parseNumber(value) {
            if (!value) return 0;
            return parseFloat(value.replace(/,/g, '')) || 0;
        }

        // Handle state dropdown change
        function handleStateChange() {
            const stateSelect = document.getElementById('state');
            const otherStateGroup = document.getElementById('otherStateGroup');
            
            if (stateSelect.value === 'other') {
                otherStateGroup.classList.add('show');
            } else {
                otherStateGroup.classList.remove('show');
                document.getElementById('otherStateInput').value = '';
            }

            updateClassCodeOptions();
            
            calculate();
        }

        // Get the effective state value
        function getEffectiveState() {
            const stateSelect = document.getElementById('state');
            if (stateSelect.value === 'other') {
                return document.getElementById('otherStateInput').value.toUpperCase();
            }
            return stateSelect.value;
        }

        function getSelectedClassCode(state, laborScope) {
            if (laborScope !== 'self') {
                return '';
            }
            const classCodeSelect = document.getElementById('classCode');
            return classCodeSelect ? classCodeSelect.value : '';
        }

        function updateClassCodeOptions() {
            const laborScope = document.getElementById('laborScope').value;
            const state = getEffectiveState();
            const classCodeGroup = document.getElementById('classCodeGroup');
            const classCodeSelect = document.getElementById('classCode');
            const classCodeHelp = document.getElementById('classCodeHelp');

            if (laborScope !== 'self') {
                classCodeGroup.style.display = 'none';
                classCodeSelect.innerHTML = '';
                return;
            }

            classCodeGroup.style.display = 'block';

            // Remember current selection
            const previousValue = classCodeSelect.value;
            classCodeSelect.innerHTML = '';

            // Add installation class codes for this state
            const installCodes = wcInstallRates[state] || {};
            for (const code in installCodes) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = code + ' - ' + (classCodeLabels[code] || 'Installation');
                classCodeSelect.appendChild(option);
            }

            // Add supply-only 8235 if available
            if (wcSupplyOnlyRates[state]) {
                const option = document.createElement('option');
                option.value = '8235';
                option.textContent = '8235 - Supply Only';
                classCodeSelect.appendChild(option);
            }

            // Restore previous selection if still valid
            if (previousValue && classCodeSelect.querySelector('option[value="' + previousValue + '"]')) {
                classCodeSelect.value = previousValue;
            }

            // Update help text
            const optionCount = classCodeSelect.options.length;
            if (optionCount > 1) {
                classCodeHelp.textContent = 'Select the appropriate class code for ' + state + '.';
            } else if (optionCount === 1) {
                classCodeHelp.textContent = 'Class code for ' + state + '.';
            } else {
                classCodeHelp.textContent = 'No WC rates on file for this state.';
            }
        }
        
        function toggleLaborFields() {
            const laborScope = document.getElementById('laborScope').value;
            const payrollGroup = document.getElementById('payrollGroup');
            const subcontractorSection = document.getElementById('subcontractorSection');
            const subAlert = document.getElementById('subAlert');
            
            payrollGroup.style.display = 'none';
            subcontractorSection.classList.remove('show');
            subAlert.classList.remove('show');
            
            if (laborScope === 'self') {
                payrollGroup.style.display = 'block';
            } else if (laborScope === 'subcontracted') {
                subcontractorSection.classList.add('show');
                subAlert.classList.add('show');
            }
            
            if (laborScope !== 'self') {
                document.getElementById('payroll').value = '';
            }

            updateClassCodeOptions();
        }
        
        function calculate() {
            const state = getEffectiveState();
            const contractValue = parseNumber(document.getElementById('contractValue').value);
            const laborScope = document.getElementById('laborScope').value;
            const payroll = parseNumber(document.getElementById('payroll').value);
            const includeOP = document.getElementById('includeOP').checked;
            const classCode = getSelectedClassCode(state, laborScope);

            let wc = 0, gl = 0, umbrella = 0;

            // GL and Umbrella based on contract value
            gl = (contractValue / 1000) * glRate;
            umbrella = (contractValue / 1000) * umbrellaRate;

            // WC calculation with Large Deductible Factor and EMR
            const rateInfoBox = document.getElementById('rateInfoBox');
            let baseRate;
            if (classCode === '8235') {
                baseRate = wcSupplyOnlyRates[state];
            } else {
                const installCodes = wcInstallRates[state];
                baseRate = installCodes ? installCodes[classCode] : undefined;
            }
            
            if (laborScope === 'self' && state && baseRate) {
                const ldFactor = ldFactors[state] || 0;
                const emr = emrFactors[state] || 1.0;

                // Calculate effective rate (LDF is a credit percentage)
                const effectiveRate = baseRate * emr * (1 - ldFactor);
                
                // Calculate WC deduction
                wc = (payroll / 100) * effectiveRate;
                
                // Display rate breakdown
                rateInfoBox.style.display = 'block';
                document.getElementById('rateState').textContent = state;
                document.getElementById('displayClassCode').textContent = classCode;
                document.getElementById('displayBaseRate').textContent = baseRate.toFixed(3);
                document.getElementById('displayEMR').textContent = emr.toFixed(2);
                document.getElementById('displayLDF').textContent = ldFactor > 0 ? ldFactor.toFixed(4) + ' (' + (ldFactor * 100).toFixed(2) + '% credit)' : 'N/A (none)';
                document.getElementById('displayEffectiveRate').textContent = effectiveRate.toFixed(4);
            } else {
                rateInfoBox.style.display = 'none';
            }

            // Round to whole dollars
            wc = Math.round(wc);
            gl = Math.round(gl);
            umbrella = Math.round(umbrella);
            const subtotal = wc + gl + umbrella;

            // Optional O&P markup
            let op = 0;
            if (includeOP) {
                op = Math.round(subtotal * 0.15);
            }

            const total = subtotal + op;

            // Update display
            document.getElementById('wcResult').textContent = '$' + wc.toLocaleString();
            document.getElementById('glResult').textContent = '$' + gl.toLocaleString();
            document.getElementById('umbrellaResult').textContent = '$' + umbrella.toLocaleString();
            document.getElementById('subtotalResult').textContent = '$' + subtotal.toLocaleString();
            document.getElementById('opResult').textContent = '$' + op.toLocaleString();
            document.getElementById('opRow').style.display = includeOP ? 'flex' : 'none';
            document.getElementById('totalResult').textContent = '$' + total.toLocaleString();
        }

        // Email Wrap Enrollment with all information
        function emailWrapEnrollment() {
            const gcName = document.getElementById('gcName').value.trim() || '[Not Provided]';
            const gcContact = document.getElementById('gcContact').value.trim();
            const projectName = document.getElementById('projectName').value || '[Project Name]';
            const projectAddress = document.getElementById('projectAddress').value.trim();
            const startDate = document.getElementById('startDate').value;
            const stateSelect = document.getElementById('state');
            let state = stateSelect.value;
            let stateFull = '';
            
            if (state === 'other') {
                const otherState = document.getElementById('otherStateInput').value;
                state = otherState ? otherState.toUpperCase() : '[Other State]';
                stateFull = state;
            } else if (!state) {
                state = '[State]';
                stateFull = state;
            } else {
                stateFull = stateNames[state] ? stateNames[state] + ' (' + state + ')' : state;
            }
            
            const contractValue = parseNumber(document.getElementById('contractValue').value);
            const laborScope = document.getElementById('laborScope').value;
            const payroll = parseNumber(document.getElementById('payroll').value);
            const includeOP = document.getElementById('includeOP').checked;
            const selectedClassCode = getSelectedClassCode(state, laborScope);
            const classCodeDisplay = selectedClassCode + ' (' + (classCodeLabels[selectedClassCode] || 'Installation') + ')';

            // Get calculated values
            const wc = document.getElementById('wcResult').textContent;
            const gl = document.getElementById('glResult').textContent;
            const umbrella = document.getElementById('umbrellaResult').textContent;
            const subtotal = document.getElementById('subtotalResult').textContent;
            const op = document.getElementById('opResult').textContent;
            const total = document.getElementById('totalResult').textContent;

            // Get subcontractor info if applicable
            let subcontractorInfo = '';
            if (laborScope === 'subcontracted') {
                const subAmount = parseNumber(document.getElementById('subAmount').value);
                const subName = document.getElementById('subName').value || '[Not Provided]';
                const subContactName = document.getElementById('subContactName').value || '[Not Provided]';
                const subContactEmail = document.getElementById('subContactEmail').value || '[Not Provided]';

                subcontractorInfo = `

SUBCONTRACTOR INFO:
- Company: ${subName}
- Labor Amount: $${subAmount.toLocaleString()}
- Contact: ${subContactName}
- Email: ${subContactEmail}`;
            }

            // Format labor scope for display
            const laborScopeDisplay = {
                'none': 'None (Delivery/Supply Only)',
                'subcontracted': 'Subcontracted',
                'self': 'Self-Performed Crews'
            }[laborScope] || laborScope;

            // Format start date
            let startDateDisplay = '[Not Specified]';
            if (startDate) {
                const date = new Date(startDate + 'T00:00:00');
                startDateDisplay = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            }

            const subject = `Wrap Enrollment Request - ${projectName} (${state === '[State]' ? 'State TBD' : stateFull})`;

            const body = `Hi Wrap Enrollment Team,

Requesting enrollment for the project below. Deduction details included.

----------------------------------------------
GC / CUSTOMER
----------------------------------------------
- GC/Customer: ${gcName}${gcContact ? '\n- Contact: ' + gcContact : ''}

----------------------------------------------
PROJECT DETAILS
----------------------------------------------
- Project Name: ${projectName}${projectAddress ? '\n- Address: ' + projectAddress : ''}
- State: ${stateFull}
- Expected Start Date: ${startDateDisplay}
- Contract Value: $${contractValue.toLocaleString()}
- Labor Scope: ${laborScopeDisplay}${laborScope === 'self' ? '\n- Estimated Payroll: $' + payroll.toLocaleString() + '\n- WC Class Code: ' + classCodeDisplay : ''}${subcontractorInfo}

----------------------------------------------
INSURANCE DEDUCTION (CALCULATED)
----------------------------------------------
- Workers' Comp (WC): ${wc}
- General Liability (GL): ${gl}
- Umbrella/Excess: ${umbrella}
- Subtotal: ${subtotal}${includeOP ? '\n- O&P (15%): ' + op : ''}
- TOTAL DEDUCTION: ${total}

Let me know if you need anything else to get this enrolled.

Thanks`;
            
            const mailtoLink = `mailto:wrap.enrollment@myfbm.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }

        updateClassCodeOptions();
    </script>
</body>
</html>
